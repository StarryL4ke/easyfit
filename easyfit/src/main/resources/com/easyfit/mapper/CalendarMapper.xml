<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.easyfit.mapper.CalendarMapper">

<!-- 일정 목록 -->
<select id="list" resultType="Map" parameterType="String">
<![CDATA[
SELECT
    mname, TO_CHAR(edate,'YYYY-MM-DD') edate
FROM
    member mem, ptrecord ptr, exerciserecord er, trainer t, trainer_auth auth
WHERE
    mem.mno = ptr.mno
    AND ptr.prno = er.prno
    AND t.tno = ptr.tno
    AND t.tid = auth.tid
    AND t.tid = #{tid}
]]>
</select>

<!-- 일정 등록 -->
<insert id="register">
INSERT INTO
    exerciserecord(erno, edate, erdate, prno)
VALUES(
    exerciserecord_seq.NEXTVAL,
    #{exerciseRecord.edate},
    #{exerciseRecord.edate},
    (
    SELECT
        prno
    FROM
        ptrecord ptr, member mem, trainer t, trainer_auth auth
    WHERE
        mem.mno = ptr.mno
        AND ptr.tno = t.tno
        AND mem.mname = #{mname}
        AND auth.tid = #{tid}
        AND prturn = (
                        SELECT
                            MAX(prturn)
                        FROM
                            member mem, ptrecord ptr, trainer t, trainer_auth auth
                        WHERE
                            mem.mno = ptr.mno
                            AND ptr.tno = t.tno
                            AND t.tid = auth.tid
                            AND mem.mname = #{mname}
                            AND auth.tid = #{tid}                
                        )
    )
)
</insert>
<!-- #{tid}의 회원 목록 -->
<select id="mnameList" resultType="String">
SELECT DISTINCT
    mname
FROM
    member mem, ptrecord ptr, trainer t, trainer_auth auth
WHERE
    mem.mno = ptr.mno
    AND ptr.tno = t.tno
    AND t.tid = auth.tid
    AND auth.tid = #{tid}
</select>

</mapper>